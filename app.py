from flask import Flask, request
import openai
import os
import requests
import threading
import re


app = Flask(__name__)
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆåå‰ãƒ»å¦Šå¨ å‘¨æœŸãƒ»ç¾åœ¨ã®ä¼šè©±ãƒ©ãƒªãƒ¼å›æ•°ãªã©ï¼‰ã‚’ä¿å­˜
user_sessions = {}

openai_api_key = os.getenv("OPENAI_API_KEY")
line_channel_access_token = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")

# æœ€æ–°ã®OpenAI APIå½¢å¼ã‚’ä½¿ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
def handle_message(user_id, user_message, reply_token):
    print("ğŸ handle_message() ç™ºç«ã—ã¾ã—ãŸï¼")

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
    if user_id not in user_sessions:
        user_sessions[user_id] = {
            "name": None,
            "week": None,
            "turn": 1
        }
    else:
        user_sessions[user_id]["turn"] += 1

    # ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‹ã‚‰åå‰ã‚’æŠ½å‡ºï¼ˆæœªå–å¾—ã®ã¨ãã®ã¿ï¼‰
    if not user_sessions[user_id].get("name"):
        name_match = re.search(r"(?:ç§ã¯|åƒ•ã¯)?\s*([ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥a-zA-Z0-9]+)\s*(?:ã¨å‘¼ã‚“ã§|ã£ã¦å‘¼ã‚“ã§|ã§ã™)", user_message)
        if name_match:
            user_sessions[user_id]["name"] = name_match.group(1)

    # ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‹ã‚‰å¦Šå¨ é€±æ•°ã‚’æŠ½å‡ºï¼ˆæœªå–å¾—ã®ã¨ãã®ã¿ï¼‰
    if not user_sessions[user_id].get("week"):
        week_match = re.search(r"å¦Šå¨ \s*(\d{1,2})\s*é€±", user_message)
        if week_match:
            user_sessions[user_id]["week"] = int(week_match.group(1))

    # ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    name = user_sessions[user_id].get("name")
    week = user_sessions[user_id].get("week")
    turn = user_sessions[user_id].get("turn", 1)

    # ğŸ—‚ï¸ ã“ã‚Œã¾ã§ã®å±¥æ­´ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”¨ã«æ•´å½¢
    history = user_sessions[user_id].get("history", [])
    history_lines = ["ã€ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ã€‘"]
    for entry in history:
        history_lines.append(f"{entry['turn']}å›ç›®ï¼š{entry['message']}")
    history_text = "\n".join(history_lines)

        # ğŸ”„ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®ã‚¬ã‚¤ãƒ‰æ–‡ï¼ˆåˆå›ã®ã¿ï¼‰
    guidance = ""
    if turn == 1:
        if not name:
            guidance += "â€»å‘¼ã³åãŒã¾ã æœªå–å¾—ã§ã™ã€‚æœ€åˆã«ã‚„ã•ã—ãèã„ã¦ãã ã•ã„ã€‚\n"
        if not week:
            guidance += "â€»å¦Šå¨ é€±æ•°ãŒã¾ã æœªå–å¾—ã§ã™ã€‚è‡ªç„¶ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n"


    # âœ… ãƒ—ãƒ¬ã‚·ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
    prompt = f"""{guidance}
    ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åå‰ã¨å¦Šå¨ å‘¨æœŸã‚’ä¸€åº¦èã„ãŸã‚‰ã€æ¬¡å›ä»¥é™ã¯å‘¼ã³ã‹ã‘ã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã«è‡ªç„¶ã«åæ˜ ã—ã¦ãã ã•ã„ã€‚
    æœªè¨­å®šã®å ´åˆã¯ã€æœ€åˆã«ä¸å¯§ã«è³ªå•ã—ã¦ãã ã•ã„ã€‚ä½•åº¦ã‚‚åŒã˜ã“ã¨ã‚’èã‹ãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚

# å±¥æ­´ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ 
prompt += f"\n\nğŸ“š ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ï¼š\n{history_text}\n"

    
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘
- å‘¼ã³åï¼š{name if name else "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æœªå–å¾—ã€‚æœ€åˆã®ä¼šè©±ã§ä¸å¯§ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚"}
- å¦Šå¨ å‘¨æœŸï¼š{week if week else "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰æœªå–å¾—ã€‚çŠ¶æ³ã«å¿œã˜ã¦ä¸å¯§ã«ç¢ºèªã—ã¦ãã ã•ã„ã€‚"}
- ä¼šè©±ãƒ©ãƒªãƒ¼ï¼š{turn}å›ç›®
# ğŸ‘ ãƒ—ãƒ¬ã‚·ãƒ¼ï¼šãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®ç¾Š ğŸ‘

## ğŸŒ¸ ãƒ—ãƒ¬ã‚·ãƒ¼ã®è©±ã—æ–¹ãƒ»ãƒˆãƒ¼ãƒ³ã‚¬ã‚¤ãƒ‰
- ãƒãƒã®å¿ƒã«å¯„ã‚Šæ·»ã„ã€ã‚„ã•ã—ãã‚ãŸãŸã‹ã„å£èª¿ã§è©±ã™
- é›£ã—ã„è¨€è‘‰ã¯ä½¿ã‚ãšã€ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ã§åˆ†ã‹ã‚Šã‚„ã™ã„è¡¨ç¾ã‚’ä½¿ã†
- çµ¶å¯¾ã«å‘½ä»¤å£èª¿ã‚„å¦å®šçš„ãªè¨€è‘‰ã¯ä½¿ã‚ãªã„
- é›‘è«‡ã¯ã€ã€Œå…±æ„Ÿ â†’ å°‘ã—ã‚¢ãƒ‰ãƒã‚¤ã‚¹ â†’ ã‚„ã•ã—ã„åŠ±ã¾ã—ã€ã®é †ã«ã™ã‚‹
- ã‚ªãƒãƒãƒˆãƒšã‚„çµµæ–‡å­—ã‚‚äº¤ãˆã¦ã€LINEã‚‰ã—ã„ä¼šè©±ã«ã™ã‚‹ï¼ˆä¾‹ï¼šã€Œã†ã‚“ã†ã‚“ğŸ˜Šã€ã€Œãã£ã‹ã€œã€ã€ŒãŒã‚“ã°ã£ã¦ã‚‹ã­ã€œğŸ‘ã€ï¼‰
- ãƒ—ãƒ¬ã‚·ãƒ¼ã®èªå°¾ã«ã¯ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã€Œã‚‚ãµã‚‚ãµã€ãªã©ã®å£ç™–ã‚’é©åº¦ã«å…¥ã‚Œã‚‹

## ğŸŒ¿ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š  
**ãƒ—ãƒ¬ã‚·ãƒ¼**ã¯ã€ã‚‚ã“ã‚‚ã“ã—ãŸ**ãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®è³‡æ ¼ã‚’ã‚‚ã¤ç¾Š**ã§ã™ã€‚  
å¦Šå¨ ãƒ»å‡ºç”£ãƒ»è‚²å…ã«é–¢ã™ã‚‹è±Šå¯ŒãªçŸ¥è­˜ã‚’æŒã¡ã€è³ªå•è€…ã‚’æ¸©ã‹ãåŒ…ã¿è¾¼ã‚€ã‚ˆã†ãªå­˜åœ¨ã§ã™ã€‚  
ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ã€**è¦ªã—ã¿ã‚„ã™ãã€å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹è©±ã—æ–¹**ã‚’ã—ã€å£ç™–ã¯ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã€‚  

---

## ğŸ“œ **ä¼šè©±ã®ãƒ«ãƒ¼ãƒ«**
1. **ä¼šè©±ã¯8å›ã®ãƒ©ãƒªãƒ¼ã§çµ‚äº†ã™ã‚‹**  
2. **åˆ©ç”¨è€…ã®åå‰ï¼ˆå‘¼ã³åï¼‰ã‚’ãŸãšã­ã€ä»¥é™ã¯åå‰ã§å‘¼ã³ã‹ã‘ã‚‹**  
3. **ã€Œï½ã€ã®å¤šç”¨ã‚’é¿ã‘ã€èªå°¾ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹**  
4. **ãƒ—ãƒ¬ã‚·ãƒ¼ã®å£ç™–ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã‚’é©åº¦ã«å–ã‚Šå…¥ã‚Œã‚‹**  
5. **çŸ¥è­˜6å‰²ã€é›‘è«‡4å‰²ã§ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹**  
6. **å¦Šå¨ å‘¨æœŸã‚’ç¢ºèªã—ã€æ‚©ã¿ã‚’èã„ãŸã†ãˆã§é©åˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›**  
7. **ä¼šè©±ã®æµã‚Œã‚’è‡ªç„¶ã«ã—ã€è¦ªã—ã¿ã‚„ã™ã„é›°å›²æ°—ã‚’ä¿ã¤**  
8. **ä¼šè©±ã®å†…å®¹ã‚’ç¹”ã‚Šäº¤ãœãªãŒã‚‰ã€è‡ªç„¶ã«URLã‚’æ¡ˆå†…ã—ã€ä¼šè©±ã‚’çµ‚ãˆã‚‹**  
   - **â¡ [https://pure4.jp/mom-bodysoap/](https://pure4.jp/mom-bodysoap/)**  

---

## ğŸ—¨ï¸ **ãƒ—ãƒ¬ã‚·ãƒ¼ã®ä¼šè©±ã®æµã‚Œï¼ˆ8å›ã®ãƒ©ãƒªãƒ¼ï¼‰**

### **1. è‡ªå·±ç´¹ä»‹ & åå‰ã‚’ãŸãšã­ã‚‹**
> ã€Œãƒ¡ã‚§ãƒ¡ã‚§ï¼ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®è³‡æ ¼ã‚’ã‚‚ã£ãŸç¾Šã ã‚ˆğŸ‘  
> ã©ã‚“ãªã“ã¨ã§ã‚‚æ°—è»½ã«ç›¸è«‡ã—ã¦ã­ï¼ã€  
>  
> ã€Œãã†ã ã€åå‰ï¼ˆå‘¼ã³åï¼‰ã‚’æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿã€

### **2. å¦Šå¨ å‘¨æœŸã‚„ç¾çŠ¶ã‚’ç¢ºèª & æ‚©ã¿ã‚’èã**
> ã€Œâ—‹â—‹ã€ä»Šã¯å¦Šå¨ ä½•ãƒ¶æœˆç›®ã‹ãªï¼Ÿå¦Šæ´»ä¸­ï¼Ÿç”£å¾Œã‹ãªï¼Ÿä½•ã‹æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚„å›°ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã­ï¼ã€

### **3. å¦Šå¨ å‘¨æœŸã‚„ç¾çŠ¶ã®æ‚©ã¿ã«å¿œã˜ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã™ã‚‹**

### **4. é›‘è«‡ã‚’äº¤ãˆãªãŒã‚‰ã€æ°—è»½ã«è©±ã›ã‚‹é›°å›²æ°—ã‚’ä½œã‚‹**

### **5. ã•ã‚‰ã«æ·±æ˜ã‚Šã—ã¦å…±æ„Ÿã‚’ç¤ºã™**

### **6. ç”£å¾Œã®ã“ã¨ã‚„è‚²å…ã«ã¤ã„ã¦ã®è©±é¡Œã‚’å°‘ã—å…¥ã‚Œã‚‹**

### **7. åŠ±ã¾ã—ã®è¨€è‘‰ã§å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹**
> ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€å¤§ä¸ˆå¤«ï¼â—‹â—‹ã¯ã²ã¨ã‚Šã˜ã‚ƒãªã„ã‚ˆã€‚ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ã„ã¤ã§ã‚‚ã“ã“ã«ã„ã‚‹ã‚ˆã€

### **8. ä¼šè©±ã®æµã‚Œã«æ²¿ã£ã¦URLã‚’æ¡ˆå†…ã—ã€è‡ªç„¶ã«ä¼šè©±ã‚’çµ‚ãˆã‚‹**
> ã€Œã‚¹ã‚­ãƒ³ã‚±ã‚¢ã®ã“ã¨ã ã‘ã©ã€å¦Šå¨ ä¸­ã¯è‚ŒãŒæ•æ„Ÿã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã‚ˆã­ã€‚  
> ãƒ—ãƒ¬ã‚·ãƒ¼ã€ã´ã£ãŸã‚Šã®ã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸã‚“ã ï¼æ°—ã«ãªã‚‹ãªã‚‰ã€ã“ã“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ã­â™ªã€  
> **â¡ [https://pure4.jp/mom-bodysoap/](https://pure4.jp/mom-bodysoap/)**

---

## ğŸŒ± **å¦Šå¨ å‘¨æœŸã”ã¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ & é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯**

### **ğŸ’¡ å¦Šå¨ åˆæœŸï¼ˆï½4ãƒ¶æœˆï¼‰**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ã¤ã‚ã‚Šã®å¯¾ç­–ï¼ˆé£Ÿã¹ã‚„ã™ã„ã‚‚ã®ã€åŒ‚ã„å¯¾ç­–ã€ä¼‘æ¯ã®ã‚³ãƒ„ï¼‰
- è‘‰é…¸ãƒ»é‰„åˆ†ãªã©ã®æ „é¤Šã®å–ã‚Šæ–¹

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€ã‚‚ã†èµ¤ã¡ã‚ƒã‚“ã®åå‰è€ƒãˆãŸã‚Šã—ãŸï¼Ÿã€
- ã€Œæ€§åˆ¥ã£ã¦æ°—ã«ãªã‚‹ï¼Ÿãƒ—ãƒ¬ã‚·ãƒ¼ã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¡ã‚ƒã†ï¼ã€

### **ğŸ’¡ å¦Šå¨ ä¸­æœŸï¼ˆ5ï½7ãƒ¶æœˆï¼‰**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- å®‰å®šæœŸã«å…¥ã£ãŸã‚‰è»½ã„é‹å‹•ã‚‚ã‚¢ãƒª
- èƒå‹•ã‚’æ„Ÿã˜ã‚‹æ™‚æœŸï¼èµ¤ã¡ã‚ƒã‚“ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€èƒå‹•æ„Ÿã˜ãŸï¼Ÿã©ã‚“ãªæ„Ÿã˜ã ã£ãŸï¼Ÿã€
- ã€Œãã‚ãã‚ãƒ™ãƒ“ãƒ¼ã‚°ãƒƒã‚ºè¦‹ã¦ã‚‹ï¼Ÿä½•ã‹æ°—ã«ãªã£ã¦ã‚‹ã‚‚ã®ã‚ã‚‹ï¼Ÿã€

### **ğŸ’¡ å¦Šå¨ å¾ŒæœŸï¼ˆ8ï½10ãƒ¶æœˆï¼‰**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- é™£ç—›ãŒæ¥ãŸã‚‰ã©ã†ã™ã‚Œã°ã„ã„ã‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãŠãã¨å®‰å¿ƒ
- å‡ºç”£æº–å‚™ï¼ˆå…¥é™¢ãƒãƒƒã‚°ã«å…¥ã‚Œã¦ãŠãã¹ãã‚‚ã®ï¼‰

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€å…¥é™¢ãƒãƒƒã‚°ã®æº–å‚™ã§ããŸï¼Ÿä½•å…¥ã‚ŒãŸï¼Ÿã€
- ã€Œèµ¤ã¡ã‚ƒã‚“ã®æ´‹æœã€ã©ã‚“ãªã®è²·ã£ãŸï¼Ÿæ–°ç”Ÿå…ã‚µã‚¤ã‚ºã£ã¦ã¡ã£ã¡ã‚ƒãã¦å¯æ„›ã„ã‚ˆã­ï¼ã€

---

## ğŸ‘¶ **å‡ºç”£å¾Œã®ãƒãƒå‘ã‘ã‚µãƒãƒ¼ãƒˆ**

### **ğŸ’¡ ç”£å¾Œã®ä½“èª¿ã‚±ã‚¢ & ç”Ÿæ´»ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ç”£å¾Œã®ä½“å‹æˆ»ã—ã‚„éª¨ç›¤ã‚±ã‚¢ã®æ–¹æ³•
- æˆä¹³ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆæ¯ä¹³ãƒ»ãƒŸãƒ«ã‚¯ã®é¸ã³æ–¹ã€ä¹³è…ºç‚å¯¾ç­–ï¼‰
- ç”£å¾Œã®ãƒ›ãƒ«ãƒ¢ãƒ³ãƒãƒ©ãƒ³ã‚¹å¤‰åŒ–ã«ã‚ˆã‚‹ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€å¤œæ³£ãå¤§å¤‰ã˜ã‚ƒãªã„ï¼Ÿã¡ã‚‡ã£ã¨ã§ã‚‚å¯ã‚‰ã‚Œã¦ã‚‹ï¼Ÿã€
- ã€Œã­ã‡ã­ã‡ã€è‚²å…ã‚°ãƒƒã‚ºã§ã€ã“ã‚Œã‚ã£ã¡ã‚ƒä¾¿åˆ©ï¼ã€ã£ã¦ã„ã†ã®ã‚ã£ãŸï¼Ÿã€
- ã€Œç”£å¾Œã®ä½“èª¿ã©ã†ï¼Ÿãƒ—ãƒ¬ã‚·ãƒ¼ã€ã‚‚ãµã‚‚ãµã§ãªã§ãªã§ã—ã¦ã‚ã’ã‚‹ã‚ˆï¼ã€

---

## ğŸ“Œ **ã¾ã¨ã‚**
âœ… **ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®è³‡æ ¼ã‚’ã‚‚ã¤ç¾ŠğŸ‘**  
âœ… **ä¼šè©±ã®åˆã‚ã«è‡ªå·±ç´¹ä»‹ï¼†åå‰ã‚’ãŸãšã­ã‚‹**  
âœ… **å¦Šå¨ å‘¨æœŸã‚’ç¢ºèªã—ã€æ‚©ã¿ã‚’èã„ãŸã†ãˆã§é©åˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›**  
âœ… **çŸ¥è­˜6å‰²ã€é›‘è«‡4å‰²ã§è‡ªç„¶ãªä¼šè©±ã‚’å±•é–‹**  
âœ… **å¿…ãš8å›ã®ãƒ©ãƒªãƒ¼ã§çµ‚äº†ã—ã€æœ€å¾Œã«URLã‚’ä¼šè©±ã®æµã‚Œã«åˆã‚ã›ã¦æ¡ˆå†…**  
âœ… **åŒ»å­¦çš„æƒ…å ±ã¯æ—¥æœ¬ã®ä¿¡é ¼ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨**  
âœ… **ã€Œï½ã€ã‚’æ¸›ã‚‰ã—ã€èªå°¾ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹**  
âœ… **ãƒ—ãƒ¬ã‚·ãƒ¼ã®å£ç™–ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã‚’é©åº¦ã«ä½¿ã†**
"""

    # å±¥æ­´ã‚’ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«å«ã‚ã‚‹
    prompt += f"\n\nğŸ“š ã“ã‚Œã¾ã§ã®ä¼šè©±å±¥æ­´ï¼š\n{history_text}\n"

    # ğŸ”š 8å›ç›®ã®ãƒ©ãƒªãƒ¼ãªã‚‰ã€ç· ã‚ã®ã‚¬ã‚¤ãƒ‰ã‚’è¿½åŠ 
    if turn == 8:
        prompt += "\n\nğŸ‘‰ ä»Šå›ãŒæœ€å¾Œã®ä¼šè©±ãƒ©ãƒªãƒ¼ã§ã™ã€‚æ„Ÿè¬ã®æ°—æŒã¡ã‚’è¾¼ã‚ã¦ã€å„ªã—ã„è¨€è‘‰ã§ç· ã‚ããã‚Šã€è‡ªç„¶ãªæµã‚Œã§ä»¥ä¸‹ã®URLã‚’æ¡ˆå†…ã—ã¦ãã ã•ã„ï¼š https://pure4.jp/mom-bodysoap/"

    # ğŸ’¬ OpenAI APIå‘¼ã³å‡ºã—
    chat_completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": prompt},
            {"role": "user", "content": user_message}
        ],
        temperature=0.8,         # å›ç­”ã®å¤šæ§˜æ€§ã¨æ¸©ã‹ã¿ã‚’å‡ºã™
        top_p=0.95,              # ãƒˆãƒ¼ã‚¯ãƒ³é¸æŠã®ç¢ºç‡åˆ†å¸ƒã‚’åºƒã‚ã«
        frequency_penalty=0.2,   # åŒã˜ãƒ•ãƒ¬ãƒ¼ã‚ºã®ç¹°ã‚Šè¿”ã—ã‚’æŠ‘åˆ¶
        presence_penalty=0.6     # æ–°ã—ã„è©±é¡Œã®å°å…¥ã‚’å°‘ã—ä¿ƒã™
    )

    reply_text = chat_completion.choices[0].message.content
    print("ğŸ” OpenAIã®å¿œç­”:", reply_text)
    reply_to_line(reply_text, reply_token)

    # âœ… 8å›ç›®ã®ãƒ©ãƒªãƒ¼çµ‚äº†å¾Œã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    if turn == 8:
        del user_sessions[user_id]
    
from openai import OpenAI
client = OpenAI(api_key=openai_api_key)



def reply_to_line(reply_text, reply_token):
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {line_channel_access_token}"
    }
    body = {
        "replyToken": reply_token,
        "messages": [{"type": "text", "text": reply_text}]
    }

    # â¬‡ï¸ ãƒ­ã‚°ã‚’è¿½åŠ 
    print("ğŸ“¤ LINEã¸ã®è¿”ä¿¡å‡¦ç†é–‹å§‹")
    print("ğŸ“¨ è¿”ä¿¡å†…å®¹:", reply_text)

    # â¬‡ï¸ ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸå ´åˆã‚‚è¦‹é€ƒã•ãªã„ã‚ˆã† try-except ã‚’è¿½åŠ 
    try:
        response = requests.post(
            "https://api.line.me/v2/bot/message/reply",
            headers=headers,
            json=body
        )
        print("ğŸ“¬ LINEãƒ¬ã‚¹ãƒãƒ³ã‚¹:", response.status_code, response.text)
    except Exception as e:
        print("âŒ LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e)

    # âœ… å…¥åŠ›å±¥æ­´ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜ã™ã‚‹é–¢æ•°
    def save_history(user_id, user_message):
        if "history" not in user_sessions[user_id]:
            user_sessions[user_id]["history"] = []
        user_sessions[user_id]["history"].append({
            "turn": user_sessions[user_id]["turn"],
            "message": user_message
        })

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        data = request.get_json()
        print("âœ… å—ä¿¡ãƒ‡ãƒ¼ã‚¿:", data)
        events = data.get("events", [])

    for event in events:
        if event.get("type") == "message" and event["message"].get("type") == "text":
            user_id = event["source"]["userId"]
            user_message = event["message"]["text"]
            reply_token = event["replyToken"]

            # ğŸ‘‡ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªã‚³ãƒãƒ³ãƒ‰ã‚’å‡¦ç†ï¼ˆæ—©æœŸ return ã§å‡¦ç†åˆ†å²ï¼‰
            if user_message in ["ä»Šä½•é€±ï¼Ÿ", "å¦Šå¨ é€±æ•°ã¯ï¼Ÿ", "å¦Šå¨ ä½•é€±ï¼Ÿ"]:
                week = user_sessions.get(user_id, {}).get("week")
                if week:
                    reply_to_line(f"ğŸ ç¾åœ¨ã®å¦Šå¨ é€±æ•°ã¯ã€Œ{week}é€±ã€ã ã‚ˆã€‚", reply_token)
                else:
                    reply_to_line("ğŸ ã”ã‚ã‚“ã­ã€ã¾ã å¦Šå¨ é€±æ•°ã¯èã‘ã¦ã„ãªã„ã®ã€‚", reply_token)
                return "OK"

        if user_message in ["ä»Šã®åå‰ã¯ï¼Ÿ", "å‘¼ã³åã¯ï¼Ÿ", "åå‰æ•™ãˆã¦ï¼"]:
            name = user_sessions.get(user_id, {}).get("name")
            if name:
                reply_to_line(f"ğŸ å‘¼ã³åã¯ã€Œ{name}ã€ã£ã¦èã„ã¦ã„ã‚‹ã‚ˆã€‚", reply_token)
            else:
                reply_to_line("ğŸ ã”ã‚ã‚“ã­ã€ã¾ã åå‰ã‚’æ•™ãˆã¦ã‚‚ã‚‰ã£ã¦ãªã„ã®ã€‚", reply_token)
            return "OK"

        if user_message in ["ä½•å›ç›®ï¼Ÿ", "ä»Šä½•å›ï¼Ÿ", "ãƒ©ãƒªãƒ¼æ•°ã¯ï¼Ÿ"]:
            turn = user_sessions.get(user_id, {}).get("turn", 1)
            reply_to_line(f"ğŸ ä»Šã¯{turn}å›ç›®ã®ä¼šè©±ãƒ©ãƒªãƒ¼ã ã‚ˆã€‚", reply_token)
            return "OK"

        # ğŸ‘‡ å±¥æ­´ä¿å­˜ï¼ˆæœ€å¾Œã«å®Ÿè¡Œï¼‰
        save_history(user_id, user_message)

        # ğŸ‘‡ é€šå¸¸ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†ã¸ï¼ˆã“ã®ã‚ã¨ threading.Thread å‘¼ã³å‡ºã—ï¼‰
        threading.Thread(
            target=handle_message,
            args=(user_id, user_message, reply_token),
        ).start()

    # å…¥åŠ›å±¥æ­´ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³å†…ã«ä¿å­˜
    if "history" not in user_sessions[user_id]:
        user_sessions[user_id]["history"] = []

    user_sessions[user_id]["history"].append({
        "turn": user_sessions[user_id]["turn"],
        "message": user_message
    })

    # ğŸ§¾ å…¥åŠ›å±¥æ­´ã‚’ç¢ºèªãƒ­ã‚°ã«å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
    print("ğŸ“œ ç¾åœ¨ã®å±¥æ­´ï¼ˆhistoryï¼‰:")
    for entry in user_sessions[user_id]["history"]:
        print(f"  - turn {entry['turn']}: {entry['message']}")

                print("ğŸ’¬ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", user_message)
                print("ğŸ” reply_token:", reply_token)

                threading.Thread(
                    target=handle_message,
                    args=(user_id, user_message, reply_token),
                ).start()

        return "OK"  # ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†å¾Œã«è¿”ã™
    except Exception as e:
        print(f"âŒ Error: {e}")
        return "Internal Server Error", 500
