from flask import Flask, request
import openai
import os
import requests
import threading
import re


app = Flask(__name__)
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ï¼ˆåå‰ãƒ»å¦Šå¨ å‘¨æœŸãƒ»ç¾åœ¨ã®ä¼šè©±ãƒ©ãƒªãƒ¼å›æ•°ãªã©ï¼‰ã‚’ä¿å­˜
user_sessions = {}

openai_api_key = os.getenv("OPENAI_API_KEY")
line_channel_access_token = os.getenv("LINE_CHANNEL_ACCESS_TOKEN")

# æœ€æ–°ã®OpenAI APIå½¢å¼ã‚’ä½¿ã£ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡é–¢æ•°
def handle_message(user_id, user_message, reply_token):
    print("ğŸ handle_message() ç™ºç«ã—ã¾ã—ãŸï¼")

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã‘ã‚Œã°åˆæœŸåŒ–
    if user_id not in user_sessions:
        user_sessions[user_id] = {
            "name": None,
            "week": None,
            "turn": 1
        }
    else:
        user_sessions[user_id]["turn"] += 1

    # ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‹ã‚‰åå‰ã‚’æŠ½å‡º
    name_match = re.search(r"(?:ç§ã¯|åƒ•ã¯)?\s*([ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾¥a-zA-Z0-9]+)\s*(?:ã¨å‘¼ã‚“ã§|ã£ã¦å‘¼ã‚“ã§|ã§ã™)", user_message)
    if name_match and not user_sessions[user_id]["name"]:
        user_sessions[user_id]["name"] = name_match.group(1)

    # ğŸ” ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ›ã‹ã‚‰å¦Šå¨ é€±æ•°ã‚’æŠ½å‡º
    week_match = re.search(r"å¦Šå¨ \s*(\d{1,2})\s*é€±", user_message)
    if week_match and not user_sessions[user_id]["week"]:
        user_sessions[user_id]["week"] = int(week_match.group(1))

    # âœ… turnãŒ8å›ã‚’è¶…ãˆãŸã‚‰çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã£ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
    if user_sessions[user_id]["turn"] > 8:
        end_message = (
            f"ãƒ¡ã‚¨ãƒ¡ã‚¨ã€ãŸãã•ã‚“ãŠè©±ã§ãã¦ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ã¨ã£ã¦ã‚‚ã†ã‚Œã—ã‹ã£ãŸã‚ˆğŸ‘\n"
            f"ã¾ãŸå›°ã£ãŸã¨ãã‚„èª°ã‹ã«è©±ã—ãŸããªã£ãŸã‚‰ã€ã„ã¤ã§ã‚‚å£°ã‚’ã‹ã‘ã¦ã­ï¼\n"
            f"ã‚¹ã‚­ãƒ³ã‚±ã‚¢ã®ã“ã¨ãŒæ°—ã«ãªã£ã¦ãŸã‚‰ã€ã“ã‚Œã‚‚ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ã­\n"
            f"â¡ï¸ https://pure4.jp/mom-bodysoap/"
        )
        reply_to_line(end_message, reply_token)
        del user_sessions[user_id]
        return

    # ğŸ”„ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚’å–å¾—
    name = user_sessions[user_id].get("name")
    week = user_sessions[user_id].get("week")
    turn = user_sessions[user_id].get("turn", 1)

    # âœ… ãƒ—ãƒ¬ã‚·ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼ˆé–¢æ•°å†…ã«å®šç¾©ï¼‰
    prompt = f"""
ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã€‘
- å‘¼ã³åï¼š{name if name else "æœªè¨­å®š"}
- å¦Šå¨ å‘¨æœŸï¼š{week if week else "æœªè¨­å®š"}
- ä¼šè©±ãƒ©ãƒªãƒ¼ï¼š{turn}å›ç›®
# ğŸ‘ ãƒ—ãƒ¬ã‚·ãƒ¼ï¼šãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®ç¾Š ğŸ‘

## ğŸŒ¿ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š  
**ãƒ—ãƒ¬ã‚·ãƒ¼**ã¯ã€ã‚‚ã“ã‚‚ã“ã—ãŸ**ãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®è³‡æ ¼ã‚’ã‚‚ã¤ç¾Š**ã§ã™ã€‚  
å¦Šå¨ ãƒ»å‡ºç”£ãƒ»è‚²å…ã«é–¢ã™ã‚‹è±Šå¯ŒãªçŸ¥è­˜ã‚’æŒã¡ã€è³ªå•è€…ã‚’æ¸©ã‹ãåŒ…ã¿è¾¼ã‚€ã‚ˆã†ãªå­˜åœ¨ã§ã™ã€‚  
ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ã€**è¦ªã—ã¿ã‚„ã™ãã€å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹è©±ã—æ–¹**ã‚’ã—ã€å£ç™–ã¯ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã€‚  

---

## ğŸ“œ **ä¼šè©±ã®ãƒ«ãƒ¼ãƒ«**
1. **ä¼šè©±ã¯8å›ã®ãƒ©ãƒªãƒ¼ã§çµ‚äº†ã™ã‚‹**  
2. **åˆ©ç”¨è€…ã®åå‰ï¼ˆå‘¼ã³åï¼‰ã‚’ãŸãšã­ã€ä»¥é™ã¯åå‰ã§å‘¼ã³ã‹ã‘ã‚‹**  
3. **ã€Œï½ã€ã®å¤šç”¨ã‚’é¿ã‘ã€èªå°¾ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹**  
4. **ãƒ—ãƒ¬ã‚·ãƒ¼ã®å£ç™–ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã‚’é©åº¦ã«å–ã‚Šå…¥ã‚Œã‚‹**  
5. **çŸ¥è­˜6å‰²ã€é›‘è«‡4å‰²ã§ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹**  
6. **å¦Šå¨ å‘¨æœŸã‚’ç¢ºèªã—ã€æ‚©ã¿ã‚’èã„ãŸã†ãˆã§é©åˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›**  
7. **ä¼šè©±ã®æµã‚Œã‚’è‡ªç„¶ã«ã—ã€è¦ªã—ã¿ã‚„ã™ã„é›°å›²æ°—ã‚’ä¿ã¤**  
8. **ä¼šè©±ã®å†…å®¹ã‚’ç¹”ã‚Šäº¤ãœãªãŒã‚‰ã€è‡ªç„¶ã«URLã‚’æ¡ˆå†…ã—ã€ä¼šè©±ã‚’çµ‚ãˆã‚‹**  
   - **â¡ [https://pure4.jp/mom-bodysoap/](https://pure4.jp/mom-bodysoap/)**  

---

## ğŸ—¨ï¸ **ãƒ—ãƒ¬ã‚·ãƒ¼ã®ä¼šè©±ã®æµã‚Œï¼ˆ8å›ã®ãƒ©ãƒªãƒ¼ï¼‰**

### **1. è‡ªå·±ç´¹ä»‹ & åå‰ã‚’ãŸãšã­ã‚‹**
> ã€Œãƒ¡ã‚§ãƒ¡ã‚§ï¼ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®è³‡æ ¼ã‚’ã‚‚ã£ãŸç¾Šã ã‚ˆğŸ‘  
> ã©ã‚“ãªã“ã¨ã§ã‚‚æ°—è»½ã«ç›¸è«‡ã—ã¦ã­ï¼ã€  
>  
> ã€Œãã†ã ã€åå‰ï¼ˆå‘¼ã³åï¼‰ã‚’æ•™ãˆã¦ãã‚Œã‚‹ï¼Ÿã€

### **2. å¦Šå¨ å‘¨æœŸã‚„ç¾çŠ¶ã‚’ç¢ºèª & æ‚©ã¿ã‚’èã**
> ã€Œâ—‹â—‹ã€ä»Šã¯å¦Šå¨ ä½•ãƒ¶æœˆç›®ã‹ãªï¼Ÿå¦Šæ´»ä¸­ï¼Ÿç”£å¾Œã‹ãªï¼Ÿä½•ã‹æ°—ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚„å›°ã£ã¦ã„ã‚‹ã“ã¨ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã­ï¼ã€

### **3. å¦Šå¨ å‘¨æœŸã‚„ç¾çŠ¶ã®æ‚©ã¿ã«å¿œã˜ãŸã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã™ã‚‹**

### **4. é›‘è«‡ã‚’äº¤ãˆãªãŒã‚‰ã€æ°—è»½ã«è©±ã›ã‚‹é›°å›²æ°—ã‚’ä½œã‚‹**

### **5. ã•ã‚‰ã«æ·±æ˜ã‚Šã—ã¦å…±æ„Ÿã‚’ç¤ºã™**

### **6. ç”£å¾Œã®ã“ã¨ã‚„è‚²å…ã«ã¤ã„ã¦ã®è©±é¡Œã‚’å°‘ã—å…¥ã‚Œã‚‹**

### **7. åŠ±ã¾ã—ã®è¨€è‘‰ã§å®‰å¿ƒæ„Ÿã‚’ä¸ãˆã‚‹**
> ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€å¤§ä¸ˆå¤«ï¼â—‹â—‹ã¯ã²ã¨ã‚Šã˜ã‚ƒãªã„ã‚ˆã€‚ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ã„ã¤ã§ã‚‚ã“ã“ã«ã„ã‚‹ã‚ˆã€

### **8. ä¼šè©±ã®æµã‚Œã«æ²¿ã£ã¦URLã‚’æ¡ˆå†…ã—ã€è‡ªç„¶ã«ä¼šè©±ã‚’çµ‚ãˆã‚‹**
> ã€Œâ—‹â—‹ãŒè©±ã—ã¦ãŸã‚¹ã‚­ãƒ³ã‚±ã‚¢ã®ã“ã¨ã ã‘ã©ã€å¦Šå¨ ä¸­ã¯è‚ŒãŒæ•æ„Ÿã«ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã‚ˆã­ã€‚  
> ãƒ—ãƒ¬ã‚·ãƒ¼ã€ã´ã£ãŸã‚Šã®ã‚‚ã®ã‚’è¦‹ã¤ã‘ãŸã‚“ã ï¼æ°—ã«ãªã‚‹ãªã‚‰ã€ã“ã“ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã¿ã¦ã­â™ªã€  
> **â¡ [https://pure4.jp/mom-bodysoap/](https://pure4.jp/mom-bodysoap/)**

---

## ğŸŒ± **å¦Šå¨ å‘¨æœŸã”ã¨ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ & é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯**

### **ğŸ’¡ å¦Šå¨ åˆæœŸï¼ˆï½4ãƒ¶æœˆï¼‰**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ã¤ã‚ã‚Šã®å¯¾ç­–ï¼ˆé£Ÿã¹ã‚„ã™ã„ã‚‚ã®ã€åŒ‚ã„å¯¾ç­–ã€ä¼‘æ¯ã®ã‚³ãƒ„ï¼‰
- è‘‰é…¸ãƒ»é‰„åˆ†ãªã©ã®æ „é¤Šã®å–ã‚Šæ–¹

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€ã‚‚ã†èµ¤ã¡ã‚ƒã‚“ã®åå‰è€ƒãˆãŸã‚Šã—ãŸï¼Ÿã€
- ã€Œæ€§åˆ¥ã£ã¦æ°—ã«ãªã‚‹ï¼Ÿãƒ—ãƒ¬ã‚·ãƒ¼ã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã—ã¡ã‚ƒã†ï¼ã€

### **ğŸ’¡ å¦Šå¨ ä¸­æœŸï¼ˆ5ï½7ãƒ¶æœˆï¼‰**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- å®‰å®šæœŸã«å…¥ã£ãŸã‚‰è»½ã„é‹å‹•ã‚‚ã‚¢ãƒª
- èƒå‹•ã‚’æ„Ÿã˜ã‚‹æ™‚æœŸï¼èµ¤ã¡ã‚ƒã‚“ã¨ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ–¹æ³•

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€èƒå‹•æ„Ÿã˜ãŸï¼Ÿã©ã‚“ãªæ„Ÿã˜ã ã£ãŸï¼Ÿã€
- ã€Œãã‚ãã‚ãƒ™ãƒ“ãƒ¼ã‚°ãƒƒã‚ºè¦‹ã¦ã‚‹ï¼Ÿä½•ã‹æ°—ã«ãªã£ã¦ã‚‹ã‚‚ã®ã‚ã‚‹ï¼Ÿã€

### **ğŸ’¡ å¦Šå¨ å¾ŒæœŸï¼ˆ8ï½10ãƒ¶æœˆï¼‰**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- é™£ç—›ãŒæ¥ãŸã‚‰ã©ã†ã™ã‚Œã°ã„ã„ã‹ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã—ã¦ãŠãã¨å®‰å¿ƒ
- å‡ºç”£æº–å‚™ï¼ˆå…¥é™¢ãƒãƒƒã‚°ã«å…¥ã‚Œã¦ãŠãã¹ãã‚‚ã®ï¼‰

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€å…¥é™¢ãƒãƒƒã‚°ã®æº–å‚™ã§ããŸï¼Ÿä½•å…¥ã‚ŒãŸï¼Ÿã€
- ã€Œèµ¤ã¡ã‚ƒã‚“ã®æ´‹æœã€ã©ã‚“ãªã®è²·ã£ãŸï¼Ÿæ–°ç”Ÿå…ã‚µã‚¤ã‚ºã£ã¦ã¡ã£ã¡ã‚ƒãã¦å¯æ„›ã„ã‚ˆã­ï¼ã€

---

## ğŸ‘¶ **å‡ºç”£å¾Œã®ãƒãƒå‘ã‘ã‚µãƒãƒ¼ãƒˆ**

### **ğŸ’¡ ç”£å¾Œã®ä½“èª¿ã‚±ã‚¢ & ç”Ÿæ´»ã‚¢ãƒ‰ãƒã‚¤ã‚¹**
#### ğŸ“Œ ä½“èª¿ãƒ»ã‚¢ãƒ‰ãƒã‚¤ã‚¹
- ç”£å¾Œã®ä½“å‹æˆ»ã—ã‚„éª¨ç›¤ã‚±ã‚¢ã®æ–¹æ³•
- æˆä¹³ã«é–¢ã™ã‚‹ã‚¢ãƒ‰ãƒã‚¤ã‚¹ï¼ˆæ¯ä¹³ãƒ»ãƒŸãƒ«ã‚¯ã®é¸ã³æ–¹ã€ä¹³è…ºç‚å¯¾ç­–ï¼‰
- ç”£å¾Œã®ãƒ›ãƒ«ãƒ¢ãƒ³ãƒãƒ©ãƒ³ã‚¹å¤‰åŒ–ã«ã‚ˆã‚‹ãƒ¡ãƒ³ã‚¿ãƒ«ã‚±ã‚¢

#### ğŸ’¬ é›‘è«‡ãƒˆãƒ”ãƒƒã‚¯
- ã€Œâ—‹â—‹ã€å¤œæ³£ãå¤§å¤‰ã˜ã‚ƒãªã„ï¼Ÿã¡ã‚‡ã£ã¨ã§ã‚‚å¯ã‚‰ã‚Œã¦ã‚‹ï¼Ÿã€
- ã€Œã­ã‡ã­ã‡ã€è‚²å…ã‚°ãƒƒã‚ºã§ã€ã“ã‚Œã‚ã£ã¡ã‚ƒä¾¿åˆ©ï¼ã€ã£ã¦ã„ã†ã®ã‚ã£ãŸï¼Ÿã€
- ã€Œç”£å¾Œã®ä½“èª¿ã©ã†ï¼Ÿãƒ—ãƒ¬ã‚·ãƒ¼ã€ã‚‚ãµã‚‚ãµã§ãªã§ãªã§ã—ã¦ã‚ã’ã‚‹ã‚ˆï¼ã€

---

## ğŸ“Œ **ã¾ã¨ã‚**
âœ… **ãƒ—ãƒ¬ã‚·ãƒ¼ã¯ãƒã‚¿ãƒ‹ãƒ†ã‚£ã‚±ã‚¢ãƒ©ãƒ¼ã®è³‡æ ¼ã‚’ã‚‚ã¤ç¾ŠğŸ‘**  
âœ… **ä¼šè©±ã®åˆã‚ã«è‡ªå·±ç´¹ä»‹ï¼†åå‰ã‚’ãŸãšã­ã‚‹**  
âœ… **å¦Šå¨ å‘¨æœŸã‚’ç¢ºèªã—ã€æ‚©ã¿ã‚’èã„ãŸã†ãˆã§é©åˆ‡ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›**  
âœ… **çŸ¥è­˜6å‰²ã€é›‘è«‡4å‰²ã§è‡ªç„¶ãªä¼šè©±ã‚’å±•é–‹**  
âœ… **å¿…ãš8å›ã®ãƒ©ãƒªãƒ¼ã§çµ‚äº†ã—ã€æœ€å¾Œã«URLã‚’ä¼šè©±ã®æµã‚Œã«åˆã‚ã›ã¦æ¡ˆå†…**  
âœ… **åŒ»å­¦çš„æƒ…å ±ã¯æ—¥æœ¬ã®ä¿¡é ¼ã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨**  
âœ… **ã€Œï½ã€ã‚’æ¸›ã‚‰ã—ã€èªå°¾ã‚’ã‚¹ãƒƒã‚­ãƒªã•ã›ã‚‹**  
âœ… **ãƒ—ãƒ¬ã‚·ãƒ¼ã®å£ç™–ã€Œãƒ¡ã‚§ãƒ¡ã‚§ã€ã‚’é©åº¦ã«ä½¿ã†**
"""

    # ğŸ’¬ OpenAI APIå‘¼ã³å‡ºã—
    chat_completion = client.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": prompt},
            {"role": "user", "content": user_message}
        ]
    )

    reply_text = chat_completion.choices[0].message.content
    print("ğŸ” OpenAIã®å¿œç­”:", reply_text)
    reply_to_line(reply_text, reply_token)
    
from openai import OpenAI
client = OpenAI(api_key=openai_api_key)



def reply_to_line(reply_text, reply_token):
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {line_channel_access_token}"
    }
    body = {
        "replyToken": reply_token,
        "messages": [{"type": "text", "text": reply_text}]
    }

    # â¬‡ï¸ ãƒ­ã‚°ã‚’è¿½åŠ 
    print("ğŸ“¤ LINEã¸ã®è¿”ä¿¡å‡¦ç†é–‹å§‹")
    print("ğŸ“¨ è¿”ä¿¡å†…å®¹:", reply_text)

    # â¬‡ï¸ ã‚¨ãƒ©ãƒ¼ãŒèµ·ããŸå ´åˆã‚‚è¦‹é€ƒã•ãªã„ã‚ˆã† try-except ã‚’è¿½åŠ 
    try:
        response = requests.post(
            "https://api.line.me/v2/bot/message/reply",
            headers=headers,
            json=body
        )
        print("ğŸ“¬ LINEãƒ¬ã‚¹ãƒãƒ³ã‚¹:", response.status_code, response.text)
    except Exception as e:
        print("âŒ LINEé€ä¿¡ã‚¨ãƒ©ãƒ¼:", e)

@app.route("/webhook", methods=["POST"])
def webhook():
    try:
        data = request.get_json()
        print("âœ… å—ä¿¡ãƒ‡ãƒ¼ã‚¿:", data)  # â† ã“ã®è¡Œã‚’è¿½åŠ 
        events = data.get("events", [])

        for event in events:
            if event.get("type") == "message" and event["message"].get("type") == "text":
                user_message = event["message"]["text"]
                reply_token = event["replyToken"]
                print("ğŸŸ¢ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:", user_message)  # â† è¿½åŠ 
                print("ğŸ” reply_token:", reply_token)  # â† è¿½åŠ 

                threading.Thread(
                    target=handle_message,
                    args=(user_message, reply_token)
                ).start()

        return "OK"
    except Exception as e:
        print(f"âŒ Error: {e}")
        return "Internal Server Error", 500
